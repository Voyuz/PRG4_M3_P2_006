<!DOCTYPE html>
<html lang="id">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Data Transaksi</title>

      <!-- Bootstrap CSS -->
      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
         rel="stylesheet"
      />

      <style>
         body {
            background-color: #f8f9fa;
            font-family: "Tahoma", sans-serif;
            padding: 20px;
         }
         .container {
            margin-top: 30px;
         }
         .table-container,
         .form-container {
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background-color: white;
            padding: 20px;
         }
         .table-container h1 {
            text-align: center;
            margin-bottom: 30px;
         }
         .table thead th {
            background-color: #343a40;
            color: white;
         }
         .form-container {
            margin-top: 20px;
            display: none;
         }
      </style>
   </head>
   <body>
      <div class="container">
         <div class="table-container">
            <h1>Daftar Transaksi</h1>
            <button id="addDataBtn" class="btn btn-primary mb-3">
               + Tambah Transaksi
            </button>
            <table
               id="transaksi-table"
               class="table table-bordered table-hover"
            >
               <thead>
                  <tr>
                     <th>ID Transaksi</th>
                     <th>Tanggal Transaksi</th>
                     <th>ID Produk</th>
                     <th>Nama Produk</th>
                     <th>Jumlah</th>
                     <th>Total Harga</th>
                     <th>Status Transaksi</th>
                     <th>Aksi</th>
                  </tr>
               </thead>
               <tbody>
                  <tr>
                     <td colspan="6" class="text-center">
                        Data transaksi akan muncul di sini...
                     </td>
                  </tr>
               </tbody>
            </table>
         </div>
      </div>

      <div class="form-container" id="formContainer">
         <h3 id="formTitle">Tambah Transaksi Baru</h3>
         <form id="transaksiForm">
            <div class="mb-3">
               <label for="tanggal" class="form-label">Tanggal Transaksi</label>
               <input
                  type="date"
                  class="form-control"
                  id="tanggalTransaksi"
                  required
               />
            </div>

            <div class="mb-3">
               <label for="idProduk" class="form-label">ID Produk</label>
               <input type="text" class="form-control" id="idProduk" required />
            </div>

            <div class="mb-3">
               <label for="namaProduk" class="form-label">Nama Produk</label>
               <input
                  type="text"
                  class="form-control"
                  id="namaProduk"
                  required
               />
            </div>

            <div class="mb-3">
               <label for="jumlah" class="form-label">Jumlah</label>
               <input type="number" class="form-control" id="jumlah" required />
            </div>

            <div class="mb-3">
               <label for="totalHarga" class="form-label">Total Harga</label>
               <input
                  type="number"
                  class="form-control"
                  id="totalHarga"
                  required
               />
            </div>

            <div class="mb-3">
               <label for="statusTransaksi" class="form-label"
                  >Status Transaksi</label
               >
               <select class="form-control" id="statusTransaksi" required>
                  <option value="Selesai">Selesai</option>
                  <option value="Pending">Pending</option>
               </select>
            </div>

            <button type="submit" class="btn btn-success" id="submitBtn">
               Submit
            </button>
            <button type="button" id="cancelBtn" class="btn btn-secondary">
               Cancel
            </button>
         </form>
      </div>

      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         const readUrl = "https://api.roniprsty.com/transaksi/read.php";
         const createUrl = "https://api.roniprsty.com/transaksi/create.php";
         const updateUrl = "https://api.roniprsty.com/transaksi/update.php";

         // Fungsi untuk ambil dan tampilkan data
         async function getTransaksi() {
            try {
               const response = await fetch(readUrl);
               if (!response.ok)
                  throw new Error(`HTTP error: ${response.status}`);

               const json = await response.json();

               // pastikan data selalu array
               let data = [];
               if (Array.isArray(json)) {
                  data = json;
               } else if (json.records && Array.isArray(json.records)) {
                  data = json.records;
               } else if (json.id_transaksi) {
                  data = [json]; // jika hanya 1 record
               }

               const tbody = document.querySelector("#transaksi-table tbody");
               tbody.innerHTML = "";

               if (data.length === 0) {
                  tbody.innerHTML = `<tr><td colspan="8" class="text-center">Tidak ada data transaksi.</td></tr>`;
                  return;
               }

               data.forEach((trx) => {
                  tbody.innerHTML += `
            <tr>
               <td>${trx.id_transaksi || ""}</td>
               <td>${trx.tanggal_transaksi || ""}</td>
               <td>${trx.id_produk || ""}</td>
               <td>${trx.nama_produk || ""}</td>
               <td>${trx.jumlah || ""}</td>
               <td>${trx.total_harga || ""}</td>
               <td>${trx.status_transaksi || ""}</td>
               <td>
                  <button class="btn btn-warning btn-sm" onclick="editTransaksi('${
                     trx.id_transaksi
                  }')">Edit</button>
               </td>
            </tr>`;
               });
            } catch (err) {
               console.error("Gagal ambil data:", err);
               document.querySelector(
                  "#transaksi-table tbody"
               ).innerHTML = `<tr><td colspan="8" class="text-center text-danger">Gagal mengambil data.</td></tr>`;
            }
         }

         getTransaksi();

         // Tombol Tambah Data
         document.getElementById("addDataBtn").addEventListener("click", () => {
            document.getElementById("formTitle").textContent =
               "Tambah Transaksi Baru";
            document.getElementById("submitBtn").textContent = "Submit";
            document.getElementById("transaksiForm").reset();
            delete document.getElementById("transaksiForm").dataset.id;
            document.getElementById("formContainer").style.display = "block";
         });

         // Tombol Cancel
         document.getElementById("cancelBtn").addEventListener("click", () => {
            document.getElementById("formContainer").style.display = "none";
         });

         // Submit Form (CREATE & UPDATE)
         document
            .getElementById("transaksiForm")
            .addEventListener("submit", async function (e) {
               e.preventDefault();

               const id = this.dataset.id;
               const trxData = {
                  id_transaksi: id || "",
                  tanggal_transaksi:
                     document.getElementById("tanggalTransaksi").value,
                  id_produk: document.getElementById("idProduk").value,
                  nama_produk: document.getElementById("namaProduk").value,
                  jumlah: document.getElementById("jumlah").value,
                  total_harga: document.getElementById("totalHarga").value,
                  status_transaksi:
                     document.getElementById("statusTransaksi").value,
               };

               try {
                  const url = id ? updateUrl : createUrl;

                  const response = await fetch(url, {
                     method: "POST",
                     headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                     },
                     body: new URLSearchParams(trxData),
                  });

                  const resultText = await response.text();
                  console.log("Server response:", resultText);

                  if (!response.ok) throw new Error("Server error");

                  alert(
                     id
                        ? "Transaksi berhasil diperbarui"
                        : "Transaksi berhasil ditambahkan"
                  );

                  await getTransaksi();
                  document.getElementById("formContainer").style.display =
                     "none";
               } catch (err) {
                  console.error("Gagal kirim data:", err);
                  alert("Gagal menyimpan transaksi.");
               }
            });

         // Edit Transaksi
         async function editTransaksi(id) {
            try {
               const response = await fetch(readUrl);
               const json = await response.json();

               let data = [];
               if (Array.isArray(json)) data = json;
               else if (json.records && Array.isArray(json.records))
                  data = json.records;
               else if (json.id_transaksi) data = [json];

               const trx = data.find((t) => t.id_transaksi == id);

               if (!trx) {
                  alert("Data transaksi tidak ditemukan.");
                  return;
               }

               document.getElementById("tanggalTransaksi").value =
                  trx.tanggal_transaksi;
               document.getElementById("idProduk").value = trx.id_produk;
               document.getElementById("namaProduk").value = trx.nama_produk;
               document.getElementById("jumlah").value = trx.jumlah;
               document.getElementById("totalHarga").value = trx.total_harga;
               document.getElementById("statusTransaksi").value =
                  trx.status_transaksi;

               document.getElementById("formTitle").textContent =
                  "Update Data Transaksi";
               document.getElementById("submitBtn").textContent = "Update";
               document.getElementById("transaksiForm").dataset.id =
                  trx.id_transaksi;
               document.getElementById("formContainer").style.display = "block";
            } catch (err) {
               console.error("Gagal edit data:", err);
               alert("Terjadi kesalahan saat mengambil data transaksi.");
            }
         }
      </script>
   </body>
</html>
